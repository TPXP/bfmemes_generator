<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BFMemes Generator</title>
    <meta property="og:url"                content="https://neurchi.gitlab.io/bfmemes" />
    <meta property="og:type"               content="website" />
    <meta property="og:title"              content="BFMemes Generator" />
    <meta property="og:description"        content="Générez facilement et rapidement votre propre BFMème!" />
    <meta property="og:image"              content="https://neurchi.gitlab.io/bfmemes/logo.jpg" />
    <link rel="icon" href="logo.jpg" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style type="text/css">
        body{
            overflow-x: hidden;
        }
        #mainContainer{
            min-height: calc(100vh - 170px);
            margin:25px;
        }
        footer{
            filter:invert(1);
            background: white;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-style: italic;
            font-family: 'Comic Sans MS', 'sans-serif';
        }
        footer img {
            height: 100px;
            margin-right:20px;
            border: 0;
        }
        footer a{
            text-decoration: none;
            font-size:0;
        }
    </style>
</head>
<body>
<div class="row" id="mainContainer">
    <form class="form-horizontal col-sm-12 col-md-4">
        <h1>BFMemes Generator&trade;</h1>
        <hr />
        <div class="form-group">
            <label for="headline">Gros titre</label>
            <input type="text" class="form-control" id="headline" placeholder="Gros titre">
        </div>
        <div class="form-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="fit-head">
                <label class="form-check-label" for="fit-head">
                    Faire rentrer mon titre dans le cadre
                </label>
            </div>
        </div>
        <hr />
        <div class="form-group">
            <label for="subtitle">Alerte INFO</label>
            <input type="text" class="form-control" id="subtitle" placeholder="Alerte INFO">
        </div>
        <div class="form-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="fit-sub">
                <label class="form-check-label" for="fit-sub">
                    Faire rentrer mon alerte info dans le cadre
                </label>
            </div>
        </div>
        <hr />
        <div class="form-group">
            <label for="image">Image</label>
            <input type="file" class="form-control-file" id="image" />
        </div>
        <button type="button" class="btn btn-lg btn-block mt-5 btn-success">
            <i class="material-icons">cloud_download</i>
            Télécharger
        </button>
    </form>
    <div id="canvasWrapper" class="col-sm-12 col-md-8">
        <canvas width="1280" height="720"></canvas>
    </div>
</div>
<footer>
    <a href="https://www.lafrenchtech.com" target="_blank">
        <img src="frenchtech.png" alt="La FrenchTech" />
    </a> Nos neurchis ont du talent
</footer>
  <script>
    const canvas = document.getElementsByTagName("canvas")[0];
    const ctx = canvas.getContext('2d');
    let imageLogo = null;
    let imageAlerte = null;
    let bgd = null;
    function reDraw() {
      ctx.fillStyle='#000';
      ctx.fillRect(0,0, 1280, 720);

      if(bgd)
        ctx.drawImage(bgd, 0, 0, 1280, 720);

      /* Bandeau du bas: 100px */
      ctx.fillStyle = '#F0EFEE';
      ctx.fillRect(0, 720-125, 1280, 100);

      /* Bandeau du haut: 100px */
      ctx.fillStyle = '#1e2677';
      ctx.fillRect(230, 720-251, 1280, 113);

      // DIRECT
      ctx.fillRect(0, 25, 290, 50);

      // Le petit carré
      ctx.fillStyle = '#e88c17';
      ctx.fillRect(125, 45, 12, 12);

      // Le petit texte "DIRECT"
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 30px sans-serif';

      ctx.fillText('DIRECT', 150, 62, 130);

      // L'heure
      ctx.textAlign = 'right';

      let time = new Date();
      let hour = '' + time.getMinutes();
      if(hour.length < 2)
        hour = 0 + hour;
      hour = time.getHours() + ':' + hour;

      ctx.fillText(hour, 112, 62, 100);

      ctx.textAlign = 'left';


      const headline = document.getElementById('headline').value;
      if(headline) {
        ctx.font = 'condensed bold 60px sans-serif';
        if(document.getElementById('fit-head').checked)
          ctx.fillText(headline, 250, 548, 1010);
        else
          ctx.fillText(headline, 250, 548);
      }

      const subtitle = document.getElementById('subtitle').value;
      if(subtitle) {
        ctx.fillStyle = '#000';
        ctx.font = 'condensed 30px sans-serif';
        if(document.getElementById('fit-sub').checked)
          ctx.fillText(subtitle, 240, 660, 1030);
        else
          ctx.fillText(subtitle, 240, 660);
      }

      // Overlay
      if(imageAlerte)
        ctx.drawImage(imageAlerte, 75, 595);

      if(imageLogo)
        ctx.drawImage(imageLogo, 73, 450);
    }
    const inputs = document.getElementsByTagName('input');
    for(let a=0; a<inputs.length;a++){
      const input = inputs[a];
      if(input.type === 'file'){
        input.onchange = function(){
          if(input.files && input.files.length) {
            // First, read the file as a data URL
            const reader = new FileReader();
            reader.onload = function(e) {
              // Set it as the source of an image tag
              const imgtag = new Image();
              imgtag.onload = function(){
                // Finally, create a bitmap with it. Easy, right?

                let sx = 0, sy = 0, sWidth = imgtag.width, sHeight = imgtag.height;
                // A bit of math to make sure the image covers everything
                if(imgtag.height / imgtag.width > 720/1280){
                  // We need to crop vertically
                  sHeight = Math.floor(imgtag.width / 1280 * 720);
                  sy = Math.floor((imgtag.height - sHeight) / 2);
                } else {
                  // We need to crop horizontally
                  sWidth = Math.floor(imgtag.height / 720 * 1280);
                  sx = Math.floor((imgtag.width- sWidth) / 2);
                }

                createImageBitmap(this, sx, sy, sWidth, sHeight).then((i) => {
                  bgd = i;
                  reDraw();
                });
              };
              imgtag.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
          }
        };
        input.onchange();
        continue;
      }
      input.oninput = reDraw;
    }
    reDraw();
    const imgTagAlerte = new Image();
    imgTagAlerte.onload = function(){
      createImageBitmap(this).then((i) => {
        imageAlerte = i;
        reDraw();
      });
    };
    imgTagAlerte.src = 'alerteInfo.jpeg';

    const imgTagLogo = new Image();
    imgTagLogo.onload = function(){
      createImageBitmap(this).then((i) => {
        imageLogo = i;
        reDraw();
      });
    };
    imgTagLogo.src = 'bfmemes.png';

    document.getElementsByTagName('button')[0].onclick = function(e) {
      e.preventDefault();
      let a = document.createElement('a');
      a.download = 'bfmeme.png';
      a.href = canvas.toDataURL("image/png");

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>