<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BFMemes Generator</title>
    <link rel="icon" href="logo.jpg" />

    <!-- Facebook OpenGraph -->
    <meta property="og:url"                content="https://bfmemes.com/" />
    <meta property="og:type"               content="website" />
    <meta property="og:title"              content="BFMemes Generator" />
    <meta property="og:description"        content="Générez facilement et rapidement votre propre BFMème!" />
    <meta property="og:image"              content="https://bfmemes.com/logo.jpg" />

    <!-- CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style type="text/css">
        body{
            overflow-x: hidden;
        }
        #mainContainer{
            min-height: calc(100vh - 170px);
            margin:25px;
        }
        footer{
            filter:invert(1);
            background: white;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-style: italic;
            font-family: 'Comic Sans MS', 'sans-serif';
        }
        footer img {
            height: 100px;
            margin-right:20px;
            border: 0;
        }
        footer a{
            text-decoration: none;
            font-size:0;
        }
    </style>
</head>
<body>
<div class="row" id="mainContainer">
    <form class="form-horizontal col-sm-12 col-md-4">
        <h1>BFMemes Generator&trade;</h1>
        <hr />
        <div class="form-group">
            <label for="headline">Gros titre</label>
            <input type="text" class="form-control" id="headline" placeholder="Gros titre">
        </div>
        <div class="form-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="fit-head">
                <label class="form-check-label" for="fit-head">
                    Faire rentrer mon titre dans le cadre
                </label>
            </div>
        </div>
        <hr />
        <div class="form-group">
            <label for="subtitle">Alerte INFO</label>
            <input type="text" class="form-control" id="subtitle" placeholder="Alerte INFO">
        </div>
        <div class="form-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="fit-sub">
                <label class="form-check-label" for="fit-sub">
                    Faire rentrer mon alerte info dans le cadre
                </label>
            </div>
        </div>
        <hr />
        <div class="form-group">
            <label for="image">Image</label>
            <input type="file" class="form-control-file" id="image" />
        </div>
        <button type="button" class="btn btn-lg btn-block mt-5 btn-success">
            <i class="material-icons">cloud_download</i>
            Télécharger
        </button>
    </form>
    <div id="canvasWrapper" class="col-sm-12 col-md-8">
        <canvas width="1280" height="720"></canvas>
    </div>
</div>
<footer>
    <a href="https://www.lafrenchtech.com" target="_blank">
        <img src="frenchtech.png" alt="La FrenchTech" />
    </a> Nos neurchis ont du talent
</footer>
  <script>
    const canvas = document.getElementsByTagName("canvas")[0];
    const ctx = canvas.getContext('2d');
    let imageLogo = null;
    let imageAlerte = null;
    let bgd = null;
    let sx, sy, dx, dy;
    let sWidth, sHeight, dWidth, dHeight;

    // Redraw the canvas image
    function reDraw() {
      ctx.fillStyle='#000';
      ctx.fillRect(0,0, 1280, 720);

      if(bgd)
        ctx.drawImage(bgd, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

      /* Bottom Ribbon: 100px */
      ctx.fillStyle = '#F0EFEE';
      ctx.fillRect(0, 595, 1280, 100);

      /* Top Ribbon: 100px */
      let gradient = ctx.createLinearGradient(0, 469, 0, 582);
      gradient.addColorStop(0,"#1B296F");
      gradient.addColorStop(1,"#2C4190");
      ctx.fillStyle = gradient;
      ctx.fillRect(230, 469, 1280, 113);

      /*** DIRECT and time in upper left corner***/
      ctx.fillRect(0, 25, 290, 50);

      // The orange square between direct and time
      ctx.fillStyle = '#e88c17';
      ctx.fillRect(125, 45, 12, 12);

      // The "DIRECT" text
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 30px sans-serif';

      ctx.fillText('DIRECT', 150, 62, 130);

      // Time
      ctx.textAlign = 'right';

      let time = new Date();
      let hour = '' + time.getMinutes();
      if(hour.length < 2)
        hour = 0 + hour;
      hour = time.getHours() + ':' + hour;

      ctx.fillText(hour, 112, 62, 100);

      ctx.textAlign = 'left';


      // Headline
      const headline = document.getElementById('headline').value;
      if(headline) {
        ctx.font = 'condensed bold 60px sans-serif';
        if(document.getElementById('fit-head').checked)
          ctx.fillText(headline, 250, 548, 1010);
        else
          ctx.fillText(headline, 250, 548);
      }

      // Subtitle (bottom ribbon)
      const subtitle = document.getElementById('subtitle').value;
      if(subtitle) {
        ctx.fillStyle = '#000';
        ctx.font = 'condensed 30px sans-serif';
        if(document.getElementById('fit-sub').checked)
          ctx.fillText(subtitle, 240, 660, 1030);
        else
          ctx.fillText(subtitle, 240, 660);
      }

      // "Alerte Info"
      if(imageAlerte)
        ctx.drawImage(imageAlerte, 75, 595);

      // BFMemes Logo
      if(imageLogo)
        ctx.drawImage(imageLogo, 73, 450);
    }

    // Handling of events on inputs
    const inputs = document.getElementsByTagName('input');
    for(let a=0; a<inputs.length;a++){
      const input = inputs[a];

      // For files, load the image before drawing it again
      if(input.type === 'file'){
        input.onchange = function(){
          if(input.files && input.files.length) {
            // First, read the file as a data URL
            const reader = new FileReader();
            reader.onload = function(e) {
              // Set it as the source of an image tag
              const imgtag = new Image();
              imgtag.onload = function(){
                // Finally, create a bitmap with it. Easy, right?
                sWidth = dWidth = imgtag.width;
                sHeight = dHeight = imgtag.height;
                sx = sy = 0;
                //By default the image will be centered
                dx = (canvas.width-sWidth)/2;
                dy = (canvas.height-sHeight)/2;

                bgd = imgtag;
                reDraw();
              };
              imgtag.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
          }
        };

        // In case there is already something (page refresh), load it
        input.onchange();
        continue;
      }

      // Text inputs don't need anything special, they're queried when drawing
      input.oninput = reDraw;
    }

    // In case there is already something in the text fields, redraw the image
    reDraw();

    // Load images for "Alerte Info"...
    const imgTagAlerte = new Image();
    imgTagAlerte.onload = function(){
      imageAlerte = imgTagAlerte;
      reDraw();
    };
    imgTagAlerte.src = 'alerteInfo.jpeg';

    // ... and the BFMemes logo
    const imgTagLogo = new Image();
    imgTagLogo.onload = function(){
      imageLogo = imgTagLogo;
      reDraw();
    };
    imgTagLogo.src = 'bfmemes.png';

    // Image download
    document.getElementsByTagName('button')[0].onclick = function(e) {
      e.preventDefault();
      let a = document.createElement('a');
      a.download = 'bfmeme.png';
      a.href = canvas.toDataURL("image/png");

      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    /*** Zoom Handling ***/
    // Last known position of the mouse/main finger
    let lastX, lastY;
    // Last known position of the second finger if relevant
    let secondFingerX, secondFingerY;
    let mouseDown = false;
    const scaleFactor = 1.1;

    canvas.addEventListener('mousedown', mouseDownHandler);
    canvas.addEventListener('mouseup', mouseUpHandler);
    canvas.addEventListener('mousemove', mouseMoveHandler);
    canvas.addEventListener('wheel', wheelHandler, false);

    canvas.addEventListener('touchstart',function (event) {
      //Same processing than mouse for main finger
      mouseDownHandler(event.touches[0]);
      //Juste save second finger position if used
      if(event.touches.length>1) {
        let rect = canvas.getBoundingClientRect();
        secondFingerX = Math.floor(event.touches[1].clientX - rect.left);
        secondFingerY = Math.floor(event.touches[1].clientY - rect.top);
      }
      //Use preventDefault everytime handling canvas event for mobile
      event.preventDefault();
    });

    canvas.addEventListener('touchmove',function (event) {
      //Use finger as mouse when their is only one
      if(event.touches.length===1)
        mouseMoveHandler(event.touches[0]);
      else {
        //Else calculate position on canvas for both
        let rect = canvas.getBoundingClientRect();
        let f1X = Math.floor(event.touches[0].clientX - rect.left);
        let f1Y = Math.floor(event.touches[0].clientY - rect.top);
        let f2X = Math.floor(event.touches[1].clientX - rect.left);
        let f2Y = Math.floor(event.touches[1].clientY - rect.top);

        //Also the distance between fingers, the last known distance and the center
        let lastDist = Math.sqrt(Math.pow(Math.abs(lastX - secondFingerX), 2) + Math.pow(Math.abs(lastY - secondFingerY), 2));
        let newDist = Math.sqrt(Math.pow(Math.abs(f1X - f2X), 2) + Math.pow(Math.abs(f1Y - f2Y), 2));
        let centerX = (f1X + f2X) / 2;
        let centerY = (f1Y + f2Y) / 2;

        //Simple cond to avoid zooming too fast when using 2 finger
        if((Math.min(lastDist, newDist)/Math.max(lastDist, newDist))<0.95) {
          //fingers mooving away
          if (lastDist < newDist) {
            zoomIn(centerX, centerY);
          } //fingers gets closer
          else {
            zoomOut(centerX, centerY);
          }
          //Then save current position for next zoom
          lastX = f1X;
          lastY = f1Y;
          secondFingerX = f2X;
          secondFingerY = f2Y;
          reDraw();
        }
      }
      event.preventDefault();
    });

    //Save current position when click is triggered
    function mouseDownHandler(event) {
      let rect = canvas.getBoundingClientRect();
      lastX = Math.floor(event.clientX - rect.left);
      lastY = Math.floor(event.clientY - rect.top);
      mouseDown = true;
    }

    function mouseUpHandler(event) {
      mouseDown = false;
    }

    //Update draw positions when mooving mouse and then redraw
    function mouseMoveHandler(event) {
      if(mouseDown) {
        let rect = canvas.getBoundingClientRect();
        let currentX = Math.floor(event.clientX - rect.left);
        let currentY = Math.floor(event.clientY - rect.top);
        dx += currentX - lastX;
        dy += currentY - lastY;
        lastX = currentX;
        lastY = currentY;
        reDraw();
      }
    }

    function wheelHandler(event){
      event.preventDefault();
      let rect = canvas.getBoundingClientRect();
      let currentX = Math.floor(event.clientX - rect.left);
      let currentY = Math.floor(event.clientY - rect.top);
      //Zoom in
      if(event.deltaY<0) {
        zoomIn(currentX, currentY);
      }
      //Zoom out
      if(event.deltaY>0) {
        zoomOut(currentX, currentY);
      }
      reDraw();
    }

    function zoomIn(x, y) {
      dx = x - (x - dx) * scaleFactor;
      dy = y - (y - dy) * scaleFactor;
      dHeight *= scaleFactor;
      dWidth *= scaleFactor;
    }

    function zoomOut(x, y) {
      dx = x - (x - dx)/scaleFactor;
      dy = y - (y - dy)/scaleFactor;
      dHeight /= scaleFactor;
      dWidth /= scaleFactor;
    }
  </script>
</body>
</html>